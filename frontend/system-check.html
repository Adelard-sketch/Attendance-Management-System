<!DOCTYPE html>
<html>
<head>
    <title>System Status Check</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
        h1 { color: #2c3e50; }
        .status-card { 
            background: #fff; 
            border: 1px solid #ddd; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        .success { border-left-color: #27ae60; background: #e8f8f5; }
        .error { border-left-color: #e74c3c; background: #fadbd8; }
        .warning { border-left-color: #f39c12; background: #fef5e7; }
        button { 
            background: #3498db; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #2980b9; }
        .result { 
            background: #ecf0f1; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .loading { color: #3498db; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #34495e; color: white; }
        .badge { 
            padding: 4px 8px; 
            border-radius: 3px; 
            font-size: 11px; 
            font-weight: bold;
        }
        .badge-success { background: #27ae60; color: white; }
        .badge-error { background: #e74c3c; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç System Status Check</h1>
        
        <div class="status-card">
            <h2>Quick Actions</h2>
            <button onclick="runAllTests()">Run All Tests</button>
            <button onclick="testDatabase()">Test Database</button>
            <button onclick="testAuthentication()">Test Authentication</button>
            <button onclick="testAPIs()">Test All APIs</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost/Activity3/api';
        let allResults = [];
        
        function addResult(category, status, message, details = '') {
            const statusClass = status === 'success' ? 'success' : status === 'error' ? 'error' : 'warning';
            const icon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚ö†Ô∏è';
            
            allResults.push({ category, status, message, details });
            
            const html = `
                <div class="status-card ${statusClass}">
                    <h3>${icon} ${category}</h3>
                    <p><strong>${message}</strong></p>
                    ${details ? `<div class="result">${details}</div>` : ''}
                </div>
            `;
            
            document.getElementById('results').innerHTML += html;
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            allResults = [];
        }
        
        async function testDatabase() {
            clearResults();
            addResult('Database Check', 'loading', 'Checking MongoDB connection...', '');
            
            try {
                const response = await fetch(`${API_BASE}/check_db.php`);
                const data = await response.json();
                
                if (data.success) {
                    addResult(
                        'Database Connection', 
                        'success', 
                        'MongoDB connected successfully',
                        `Database: ${data.database}\nUsers: ${data.users_count}\nCourses: ${data.courses_count}`
                    );
                } else {
                    addResult('Database Connection', 'error', 'MongoDB connection failed', data.error);
                }
            } catch (error) {
                addResult('Database Connection', 'error', 'Failed to reach database check endpoint', error.message);
            }
        }
        
        async function testAuthentication() {
            clearResults();
            const user = localStorage.getItem('loggedInUser');
            const role = localStorage.getItem('userType');
            
            if (user && role) {
                addResult(
                    'Authentication Status', 
                    'success', 
                    'User is logged in',
                    `Username: ${user}\nRole: ${role}\nFull Name: ${localStorage.getItem('fullname') || 'N/A'}`
                );
            } else {
                addResult('Authentication Status', 'warning', 'No user logged in', 'Please login to test authenticated endpoints');
            }
        }
        
        async function testAPIs() {
            clearResults();
            
            const apis = [
                { name: 'Courses API', url: `${API_BASE}/manageCourses.php?action=list` },
                { name: 'Enrollments API', url: `${API_BASE}/manageEnrollments.php?action=list` },
                { name: 'Sessions API', url: `${API_BASE}/manageSessions.php?action=list` },
                { name: 'Attendance API', url: `${API_BASE}/manageAttendance.php?action=student_attendance` },
            ];
            
            for (const api of apis) {
                try {
                    const response = await fetch(api.url, { credentials: 'include' });
                    const data = await response.json();
                    
                    if (data.success) {
                        const itemCount = data.courses?.length || data.requests?.length || data.sessions?.length || data.attendance?.length || 0;
                        addResult(
                            api.name,
                            'success',
                            `Working correctly (${itemCount} items)`,
                            JSON.stringify(data, null, 2).substring(0, 500)
                        );
                    } else {
                        addResult(api.name, 'warning', data.message || 'No data returned', JSON.stringify(data, null, 2));
                    }
                } catch (error) {
                    addResult(api.name, 'error', 'Fetch failed', error.message);
                }
            }
        }
        
        async function runAllTests() {
            clearResults();
            addResult('System Check', 'loading', 'Running all tests...', '');
            
            await testDatabase();
            await testAuthentication();
            await testAPIs();
            
            // Summary
            const successCount = allResults.filter(r => r.status === 'success').length;
            const errorCount = allResults.filter(r => r.status === 'error').length;
            const warningCount = allResults.filter(r => r.status === 'warning').length;
            
            const summaryStatus = errorCount > 0 ? 'error' : warningCount > 0 ? 'warning' : 'success';
            
            document.getElementById('results').innerHTML = `
                <div class="status-card ${summaryStatus}">
                    <h2>üìä Test Summary</h2>
                    <p>
                        ‚úÖ Passed: ${successCount} | 
                        ‚ö†Ô∏è Warnings: ${warningCount} | 
                        ‚ùå Failed: ${errorCount}
                    </p>
                </div>
            ` + document.getElementById('results').innerHTML;
        }
        
        // Auto-run on load
        window.onload = () => {
            runAllTests();
        };
    </script>
</body>
</html>
